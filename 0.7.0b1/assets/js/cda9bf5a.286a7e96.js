"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[94],{3905:function(e,t,n){n.d(t,{Zo:function(){return m},kt:function(){return u}});var a=n(7294);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,a,o=function(e,t){if(null==e)return{};var n,a,o={},r=Object.keys(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||(o[n]=e[n]);return o}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}var l=a.createContext({}),d=function(e){var t=a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},m=function(e){var t=d(e.components);return a.createElement(l.Provider,{value:t},e.children)},p={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},c=a.forwardRef((function(e,t){var n=e.components,o=e.mdxType,r=e.originalType,l=e.parentName,m=s(e,["components","mdxType","originalType","parentName"]),c=d(n),u=o,_=c["".concat(l,".").concat(u)]||c[u]||p[u]||r;return n?a.createElement(_,i(i({ref:t},m),{},{components:n})):a.createElement(_,i({ref:t},m))}));function u(e,t){var n=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var r=n.length,i=new Array(r);i[0]=c;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s.mdxType="string"==typeof e?e:o,i[1]=s;for(var d=2;d<r;d++)i[d]=n[d];return a.createElement.apply(null,i)}return a.createElement.apply(null,n)}c.displayName="MDXCreateElement"},6732:function(e,t,n){n.r(t),n.d(t,{assets:function(){return m},contentTitle:function(){return l},default:function(){return u},frontMatter:function(){return s},metadata:function(){return d},toc:function(){return p}});var a=n(7462),o=n(3366),r=(n(7294),n(3905)),i=["components"],s={sidebar_position:2},l="Reliability data",d={unversionedId:"getting_started/toy_shop/compute_monitoring",id:"getting_started/toy_shop/compute_monitoring",title:"Reliability data",description:"Now, let's compute the first health data. The toy shop sample project already has re_data configuration defined, but let's go over it and see what we needed to configure.",source:"@site/docs/getting_started/toy_shop/compute_monitoring.md",sourceDirName:"getting_started/toy_shop",slug:"/getting_started/toy_shop/compute_monitoring",permalink:"/0.7.0b1/docs/getting_started/toy_shop/compute_monitoring",editUrl:"https://github.com/re-data/re-data/edit/master/docs/docs/getting_started/toy_shop/compute_monitoring.md",tags:[],version:"current",sidebarPosition:2,frontMatter:{sidebar_position:2},sidebar:"tutorialSidebar",previous:{title:"Welcome to toy shop!",permalink:"/0.7.0b1/docs/getting_started/toy_shop/toy_shop_data"},next:{title:"Reliability UI \ud83d\udc40",permalink:"/0.7.0b1/docs/getting_started/toy_shop/generate_ui"}},m={},p=[{value:"re_data configuration",id:"re_data-configuration",level:2},{value:"First re_data run",id:"first-re_data-run",level:2},{value:"re_data run for ten first days of January",id:"re_data-run-for-ten-first-days-of-january",level:2},{value:"Looking into anomalies",id:"looking-into-anomalies",level:2},{value:"Running tests",id:"running-tests",level:2}],c={toc:p};function u(e){var t=e.components,n=(0,o.Z)(e,i);return(0,r.kt)("wrapper",(0,a.Z)({},c,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"reliability-data"},"Reliability data"),(0,r.kt)("p",null,"Now, let's compute the first health data. The toy shop sample project already has re_data configuration defined, but let's go over it and see what we needed to configure."),(0,r.kt)("h2",{id:"re_data-configuration"},"re_data configuration"),(0,r.kt)("p",null,"For re_data pending orders models, we do have in file configuration defined:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sql",metastring:"title=toy_shop/models/pending_orders_per_customers.sql",title:"toy_shop/models/pending_orders_per_customers.sql"},"\n{{\n    config(\n        re_data_monitored=true,\n        re_data_time_filter='time_created',\n        re_data_anomaly_detector={'name': 'z_score', 'threshold': 2.2},\n    )\n}}\n\nselect o.id, o.amount ...\n\n")),(0,r.kt)("p",null,"This configuration makes the",(0,r.kt)("inlineCode",{parentName:"p"}," pending_orders_per_customers")," model monitored by re_data and uses column named: ",(0,r.kt)("inlineCode",{parentName:"p"},"time_created")," as timestamp column when computing re_data stats."),(0,r.kt)("p",null,"We also optionally configured an anomaly detector to check for anomalies for this table. Other additional things we can configure are:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"re_data_columns")," - to specify for what table columns re_data metrics should be computed"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"re_data_metrics")," - to add additional metrics to be computed for the table")),(0,r.kt)("p",null,"For re_data seed files, let's look into the ",(0,r.kt)("inlineCode",{parentName:"p"},"toy_shop/seeds/schema.yml")," file:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yml",metastring:"title=toy_shop/seeds/schema.yml",title:"toy_shop/seeds/schema.yml"},"version: 2\n\nseeds:\n  - name: customers\n    config:\n      re_data_monitored: true\n      re_data_time_filter: null\n\n    columns:\n      - name: id\n        tests:\n          - not_null\n          - unique\n\n  - name: orders\n    config:\n      re_data_monitored: true\n      re_data_time_filter: time_created\n      re_data_anomaly_detector:\n        name: modified_z_score\n        threshold: 3.5\n  ...\n")),(0,r.kt)("p",null,"We do see the ",(0,r.kt)("inlineCode",{parentName:"p"},"re_data_monitored")," set for both of those tables. For the ",(0,r.kt)("inlineCode",{parentName:"p"},"customers")," table as data, there doesn't have any timestamp column we set ",(0,r.kt)("inlineCode",{parentName:"p"},"re_data_time_filter")," to null to compute stats globally for the whole table. For the ",(0,r.kt)("inlineCode",{parentName:"p"},"orders")," table similarly to the pending orders table we set it to the ",(0,r.kt)("inlineCode",{parentName:"p"},"time_created")," column. "),(0,r.kt)("p",null,"Additionally for the ",(0,r.kt)("inlineCode",{parentName:"p"},"orders")," table, we configure the ",(0,r.kt)("inlineCode",{parentName:"p"},"re_data_anomaly_detector")," method and set up a specific threshold to be used when looking for anomalies in this table."),(0,r.kt)("p",null,"Apart from configuration specific to some of the tables (or table groups) re_data also has a possibility to define global configuration which will apply to all data computed. This is defined in the ",(0,r.kt)("inlineCode",{parentName:"p"},"vars")," section of ",(0,r.kt)("inlineCode",{parentName:"p"},"dbt_project.yml"),"."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yml",metastring:"title=toy_shop/dbt_project.yml",title:"toy_shop/dbt_project.yml"},"vars:\n  re_data:anomaly_detector:\n    name: modified_z_score\n    threshold: 3\n")),(0,r.kt)("p",null,"Here we set the anomaly_detector method for re_data globally. This will have ",(0,r.kt)("strong",{parentName:"p"},"less")," priority than model defined configurations. In general re_data configuration follows the rule that the more specific configuration, the more important it is."),(0,r.kt)("p",null,"Now with this explained, we can compute re_data models for the first time:"),(0,r.kt)("h2",{id:"first-re_data-run"},"First re_data run"),(0,r.kt)("p",null,"We choose to run re_data for the first day of 2021."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},'dbt run --models package:re_data --vars \\\n   \'{\n     "re_data:time_window_start": "2021-01-01 00:00:00",\n     "re_data:time_window_end": "2021-01-02 00:00:00"\n    }\'\n')),(0,r.kt)("div",{className:"admonition admonition-info alert alert--info"},(0,r.kt)("div",{parentName:"div",className:"admonition-heading"},(0,r.kt)("h5",{parentName:"div"},(0,r.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,r.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,r.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"}))),"info")),(0,r.kt)("div",{parentName:"div",className:"admonition-content"},(0,r.kt)("p",{parentName:"div"},"Notice that ",(0,r.kt)("inlineCode",{parentName:"p"},"re_data:time_window_start")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"re_data:time_window_end")," are another global configuration parameters. They can be defined also in the ",(0,r.kt)("inlineCode",{parentName:"p"},"dbt_project.yml")," vars file, but here we want them to be more dynamic and we use a dbt ",(0,r.kt)("inlineCode",{parentName:"p"},"--vars")," option to pass them. If we don't pass time window parameters re_data will compute stats for the previous day. (from yesterday's 00:00 AM up until today 00:00 AM)"))),(0,r.kt)("p",null,"Anytime re_data computes its models, it detects tables being monitored, their configuration and that inside your database as a re_data model."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sql"},'postgres=> SELECT * FROM toy_shop_re.re_data_monitored;\n\n            name             |  schema  | database | time_filter  | metrics | columns |                anomaly_detector\n-----------------------------+----------+----------+--------------+---------+---------+------------------------------------------------\n pending_orders_per_customer | toy_shop | postgres | time_created | {}      | []      | {"name": "z_score", "threshold": 2.2}\n customers                   | toy_shop | postgres |              | {}      | []      | {"name": "modified_z_score", "threshold": 3}\n orders                      | toy_shop | postgres | time_created | {}      | []      | {"name": "modified_z_score", "threshold": 3.5}\n')),(0,r.kt)("p",null,"You would notice that here we will also see ",(0,r.kt)("em",{parentName:"p"},"final")," configuration applied when actually computing models (taking into account priorties from different configuration levels). More information on configuration can be found ",(0,r.kt)("a",{parentName:"p",href:"/docs/reference/config"},"here"),"."),(0,r.kt)("div",{className:"admonition admonition-info alert alert--info"},(0,r.kt)("div",{parentName:"div",className:"admonition-heading"},(0,r.kt)("h5",{parentName:"div"},(0,r.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,r.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,r.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"}))),"info")),(0,r.kt)("div",{parentName:"div",className:"admonition-content"},(0,r.kt)("p",{parentName:"div"},"Notice that table was created inside ",(0,r.kt)("inlineCode",{parentName:"p"},"toy_shop_re")," schema. re_data tables are by default created with this schema suffix, ",(0,r.kt)("em",{parentName:"p"},"except ",(0,r.kt)("inlineCode",{parentName:"em"},"toy_shop_re_internal"))," tables which are internal tables not be used directly by you. You can change this behaviour however you want, we use following dbt config for our models. (which can be overwritten)"),(0,r.kt)("pre",{parentName:"div"},(0,r.kt)("code",{parentName:"pre",className:"language-yml",metastring:"title=dbt_project.yml",title:"dbt_project.yml"},"models:\n  re_data:\n    +schema: re\n    internal:\n      +schema: re_internal\n")))),(0,r.kt)("p",null,"Metrics have been computed for the window between 2021-01-01 and 2021-01-02, let us see how many rows we have for the tables being monitored. The ",(0,r.kt)("inlineCode",{parentName:"p"},"row_count")," metric gives us that."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sql",metastring:'title="Viewing computed metrics"',title:'"Viewing',computed:!0,'metrics"':!0},'postgres=> SELECT table_name, metric, value, time_window_start, time_window_end from toy_shop_re.re_data_metrics where metric in( \'row_count\', \'global__row_count\');\n\n                     table_name                      |      metric       | value |  time_window_start  |   time_window_end\n-----------------------------------------------------+-------------------+-------+---------------------+---------------------\n "postgres"."toy_shop"."customers"                   | global__row_count |    15 | 2021-01-01 00:00:00 | 2021-01-02 00:00:00\n "postgres"."toy_shop"."orders"                      | row_count         |    20 | 2021-01-01 00:00:00 | 2021-01-02 00:00:00\n "postgres"."toy_shop"."pending_orders_per_customer" | row_count         |     5 | 2021-01-01 00:00:00 | 2021-01-02 00:00:00\n')),(0,r.kt)("div",{className:"admonition admonition-info alert alert--info"},(0,r.kt)("div",{parentName:"div",className:"admonition-heading"},(0,r.kt)("h5",{parentName:"div"},(0,r.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,r.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,r.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"}))),"info")),(0,r.kt)("div",{parentName:"div",className:"admonition-content"},(0,r.kt)("p",{parentName:"div"},"Note, if a model being monitored has no time filter specified, re_data will compute the metric over the whole table. A ",(0,r.kt)("inlineCode",{parentName:"p"},"global__")," prefix would be added to that metric."))),(0,r.kt)("h2",{id:"re_data-run-for-ten-first-days-of-january"},"re_data run for ten first days of January"),(0,r.kt)("p",null,"On production, we would set up re_data to run daily/hourly/etc. For toy shop, by using the re_data python package command we backfill daily data for the past."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"re_data run --start-date 2021-01-01 --end-date 2021-01-11\n")),(0,r.kt)("h2",{id:"looking-into-anomalies"},"Looking into anomalies"),(0,r.kt)("p",null,"And now let's look into the ",(0,r.kt)("inlineCode",{parentName:"p"},"re_data_anomalies")," table to see if ",(0,r.kt)("inlineCode",{parentName:"p"},"re_data")," found anything suspicious for us:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sql",metastring:'title="Viewing computed anomalies"',title:'"Viewing',computed:!0,'anomalies"':!0},'postgres=> select table_name, metric, z_score_value, modified_z_score_value, last_value, time_window_end from toy_shop_re.re_data_anomalies;\n\n                     table_name                      |   metric   |  z_score_value   | modified_z_score_value |    last_value    |   time_window_end\n-----------------------------------------------------+------------+------------------+------------------------+------------------+---------------------\n "postgres"."toy_shop"."orders"                      | stddev     | 2.26512659456492 |       33.1559468401042 | 76623.0542133031 | 2021-01-08 00:00:00\n "postgres"."toy_shop"."orders"                      | max        | 1.90332380570845 |       5.39599999982013 |              220 | 2021-01-08 00:00:00\n "postgres"."toy_shop"."orders"                      | avg        | 2.23609834440421 |       12.5165457875454 | 83714.2857142857 | 2021-01-08 00:00:00\n "postgres"."toy_shop"."orders"                      | variance   | 2.17679662067361 |       14.3162734688659 | 5933.28235294118 | 2021-01-08 00:00:00\n "postgres"."toy_shop"."orders"                      | avg_length | 1.99359828729157 |       4.83162244794424 | 12.1428571428571 | 2021-01-08 00:00:00\n "postgres"."toy_shop"."orders"                      | stddev     | 2.12566830905018 |       12.0321401712802 | 77.0278024672986 | 2021-01-08 00:00:00\n "postgres"."toy_shop"."orders"                      | row_count  | 1.97360659802582 |       5.05874999974706 |               35 | 2021-01-08 00:00:00\n "postgres"."toy_shop"."orders"                      | variance   | 2.26750636806239 |       96.2432445786529 | 5871092436.97479 | 2021-01-08 00:00:00\n "postgres"."toy_shop"."pending_orders_per_customer" | avg        | 2.23118408449371 |       11.0541393078969 | 114782.608695652 | 2021-01-08 00:00:00\n "postgres"."toy_shop"."pending_orders_per_customer" | max        | 2.25075673466898 |       27.6544999999994 |           250000 | 2021-01-08 00:00:00\n')),(0,r.kt)("p",null,"We can see there are a couple of things re_data flagged for us. Recall that re_data would flag anomalies based on the method of detection and the threshold set."),(0,r.kt)("h2",{id:"running-tests"},"Running tests"),(0,r.kt)("p",null,"Before moving on and investigating it in re_data UI. Let's run tests to see if they point to any problems in our data."),(0,r.kt)("p",null,"First we update the dbt_project.yml file to add an ",(0,r.kt)("a",{parentName:"p",href:"https://docs.getdbt.com/reference/project-configs/on-run-start-on-run-end"},"on-run-end")," hook. This macro provided makes it possible to save test history to your database on each test run."),(0,r.kt)("div",{className:"admonition admonition-caution alert alert--warning"},(0,r.kt)("div",{parentName:"div",className:"admonition-heading"},(0,r.kt)("h5",{parentName:"div"},(0,r.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,r.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 16 16"},(0,r.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"}))),"caution")),(0,r.kt)("div",{parentName:"div",className:"admonition-content"},(0,r.kt)("p",{parentName:"div"},"on-run-end hooks are called for dbt tests since dbt 1.0.0, so this re_data feature is only available for dbt versions >= 1.0.0."))),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml",metastring:'title="toy_shop/dbt_project.yml"',title:'"toy_shop/dbt_project.yml"'},'on-run-end:\n  - "{{ re_data.save_test_history(results) }}"\n')),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash",metastring:'title="Running tests"',title:'"Running','tests"':!0},"$ dbt test --select package:toy_shop\n\n...\n\n22:36:20  1 of 7 START test accepted_values_orders_status__PENDING_PAYMENT__PAID__SHIPPED__DELIVERED [RUN]\n22:36:20  2 of 7 START test not_null_customers_id......................................... [RUN]\n22:36:20  3 of 7 START test not_null_orders_amount........................................ [RUN]\n22:36:20  4 of 7 START test not_null_orders_customer_id................................... [RUN]\n22:36:21  2 of 7 PASS not_null_customers_id............................................... [PASS in 0.12s]\n22:36:21  3 of 7 PASS not_null_orders_amount.............................................. [PASS in 0.13s]\n22:36:21  4 of 7 PASS not_null_orders_customer_id......................................... [PASS in 0.13s]\n22:36:21  1 of 7 PASS accepted_values_orders_status__PENDING_PAYMENT__PAID__SHIPPED__DELIVERED [PASS in 0.13s]\n22:36:21  5 of 7 START test not_null_orders_status........................................ [RUN]\n22:36:21  6 of 7 START test not_null_orders_time_created.................................. [RUN]\n22:36:21  7 of 7 START test unique_customers_id........................................... [RUN]\n22:36:21  5 of 7 PASS not_null_orders_status.............................................. [PASS in 0.05s]\n22:36:21  6 of 7 PASS not_null_orders_time_created........................................ [PASS in 0.05s]\n22:36:21  7 of 7 PASS unique_customers_id................................................. [PASS in 0.05s]\n22:36:21  \n22:36:21  Finished running 7 tests in 0.56s.\n22:36:21  \n22:36:21  Completed successfully\n22:36:21  \n22:36:21  Done. PASS=7 WARN=0 ERROR=0 SKIP=0 TOTAL=7\n\n")),(0,r.kt)("p",null,"Ok, so all of the tests are actually passing. Let's move to the next chapter and investigate what's going on."))}u.isMDXComponent=!0}}]);